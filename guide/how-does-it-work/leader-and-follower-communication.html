<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Leader and Follower Communication | FunFair Wallet Documentation</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/fun-wallet-docs/logo.svg">
    <link rel="manifest" href="/fun-wallet-docs/manifest.json">
    <link rel="apple-touch-icon" href="/fun-wallet-docs/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/fun-wallet-docs/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="Welcome">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/fun-wallet-docs/assets/css/0.styles.d2ddfb65.css" as="style"><link rel="preload" href="/fun-wallet-docs/assets/js/app.6513ce21.js" as="script"><link rel="preload" href="/fun-wallet-docs/assets/js/2.a0d94ea1.js" as="script"><link rel="preload" href="/fun-wallet-docs/assets/js/17.09c5e52a.js" as="script"><link rel="preload" href="/fun-wallet-docs/assets/js/5.c35ce4c3.js" as="script"><link rel="prefetch" href="/fun-wallet-docs/assets/js/10.7bbbbc32.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/11.3f2a87a3.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/12.83027ded.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/13.a6b2a7fa.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/14.0fb219e4.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/15.f30583d8.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/16.9b70c3c3.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/18.e3118307.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/19.6b1ffd3e.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/20.3e6aaa4c.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/21.ecdb9b52.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/22.88b89ca7.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/23.f81bf215.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/24.8db98613.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/25.8e82babc.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/26.e0441623.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/27.2ec3f875.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/28.12d571d0.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/29.5ab087e3.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/3.7515ba86.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/30.d587356e.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/31.39237edc.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/32.49d3409a.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/33.207cd617.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/34.3f63557b.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/35.ca36b09d.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/36.54b8a6b4.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/37.5d3324e5.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/38.beede36e.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/39.229c0418.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/4.e3251b57.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/40.8130e260.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/41.5625c8b3.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/42.dbde1b2e.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/43.904dcb46.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/44.c4c91deb.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/45.b7b086e4.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/6.37b07a85.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/7.cf304ae3.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/8.0a8332f4.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/9.199cbcee.js">
    <link rel="stylesheet" href="/fun-wallet-docs/assets/css/0.styles.d2ddfb65.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fun-wallet-docs/" class="home-link router-link-active"><img src="/fun-wallet-docs/logo.svg" alt="FunFair Wallet Documentation" class="logo"> <span class="site-name can-hide">FunFair Wallet Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fun-wallet-docs/guide/" class="nav-link router-link-active">
  Guide
</a></div> <a href="https://github.com/funfair-tech/fun-wallet-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fun-wallet-docs/guide/" class="nav-link router-link-active">
  Guide
</a></div> <a href="https://github.com/funfair-tech/fun-wallet-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Information</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fun-wallet-docs/guide/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/fun-wallet-docs/guide/information/getting-started.html" class="sidebar-link">Getting Started</a></li><li><a href="/fun-wallet-docs/guide/information/browser-support.html" class="sidebar-link">Browser Support</a></li><li><a href="/fun-wallet-docs/guide/information/testing.html" class="sidebar-link">Our Testing</a></li><li><a href="/fun-wallet-docs/guide/information/layouts.html" class="sidebar-link">Layouts</a></li><li><a href="/fun-wallet-docs/guide/information/branding.html" class="sidebar-link">Branding</a></li><li><a href="/fun-wallet-docs/guide/information/kyc.html" class="sidebar-link">KYC</a></li><li><a href="/fun-wallet-docs/guide/information/fiat-gateway.html" class="sidebar-link">Fiat Gateway</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>How Does It Work?</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fun-wallet-docs/guide/how-does-it-work/how-authentication-works.html" class="sidebar-link">How Authentication Works</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/registration.html" class="sidebar-link">Registration</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/login-and-recovery-token-generation.html" class="sidebar-link">Login and Recovery Token Generation</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/recovery.html" class="sidebar-link">Recovery</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/re-authentication.html" class="sidebar-link">Re-authentication</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/how-is-the-authentication-secure.html" class="sidebar-link">How is the Authentication Secure?</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/how-popup-authenticates-leader.html" class="sidebar-link">How the Authenticated Popup Authenticates the Leader</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html" aria-current="page" class="active sidebar-link">Leader and Follower Communication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#what-is-a-leader-instance" class="sidebar-link">What is a Leader Instance?</a></li><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#what-is-a-follower" class="sidebar-link">What is a Follower?</a></li><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#secure-communication-between-the-leader-and-follower" class="sidebar-link">Secure Communication Between the Leader and Follower</a></li><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#how-is-the-leader-and-follower-communication-secure" class="sidebar-link">How is the Leader and Follower Communication Secure?</a></li></ul></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/how-broadcast-works.html" class="sidebar-link">How Broadcast Works</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/fun-wallet-sdk.html" class="sidebar-link">FunFair Wallet SDK</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/fun-wallet-ethereum-provider.html" class="sidebar-link">FunFair Wallet Ethereum Provider</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/blooms.html" class="sidebar-link">Blooms</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Web SDK</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fun-wallet-docs/guide/web-sdk/installing-sdk.html" class="sidebar-link">Installing the FunFair Wallet SDK</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/setting-up-the-sdk-with-project.html" class="sidebar-link">Setting Up the SDK in Your Project</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/initialising-the-sdk.html" class="sidebar-link">Initialising the SDK</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/authentication.html" class="sidebar-link">Authentication</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/wallet-ui.html" class="sidebar-link">Show Wallet UI</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/routing.html" class="sidebar-link">Routing and Deep Linking</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/languages.html" class="sidebar-link">Languages</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/approval-modal.html" class="sidebar-link">Approval Modals</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/ethereum-provider.html" class="sidebar-link">Ethereum Provider</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/sdk-methods.html" class="sidebar-link">SDK Methods</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/sdk-event-listeners.html" class="sidebar-link">SDK Event Listeners</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Server &gt; Server API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fun-wallet-docs/guide/server-to-server-api/introduction.html" class="sidebar-link">Introduction</a></li><li><a href="/fun-wallet-docs/guide/server-to-server-api/authorization.html" class="sidebar-link">Authorization</a></li><li><a href="/fun-wallet-docs/guide/server-to-server-api/user-information.html" class="sidebar-link">User information</a></li><li><a href="/fun-wallet-docs/guide/server-to-server-api/encrypted-user-information.html" class="sidebar-link">Encrypted user information</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="leader-and-follower-communication"><a href="#leader-and-follower-communication" class="header-anchor">#</a> Leader and Follower Communication</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>Since the Wallet can't trust the dApp hosting the client, it can't pass sensitive data through to the SDK, because that's hosted on the dApp and would mean the dApp could get access to that sensitive data (e.g. the private key), which would be an unacceptable security compromise. The 'Leader and Follower' solution allows communication between the <code>leader</code> and the <code>follower</code> without the dApp being able to intercept the data, allowing the Wallet to have two instances of itself running for reasons described below.</p> <p>If iframes are removed from the DOM, it kills the instance and when added back to the DOM it reloads itself. Also, if you move an iframe using JavaScript it also reloads itself - so there is no such thing as <code>magic iframes</code>.</p> <p>As the Wallet needs to be authenticated and then never reloaded due to it holding the user's private key in memory, this causes a bit of a problem. Front-end apps of today use awesome frameworks like Angular and React, and developers want to take advantage of lazy loading and other solid approaches. If you just had one instance which never got removed from the DOM it would only work on a very basic Web app hence where the <code>leader</code> and <code>follower</code> come in.</p> <h2 id="what-is-a-leader-instance"><a href="#what-is-a-leader-instance" class="header-anchor">#</a> What is a Leader Instance?</h2> <p>The <code>leader</code> is the authenticated instance which never gets removed from the DOM or moved. The <code>leader</code> is the communication window which speaks to the SDK. This is in charge of spawning up a new <code>follower</code> instance and runs the show. Your dApp will only ever speak to the leader when it needs to perform SDK calls. All event listeners and messages will be sent to the parent from the <code>leader</code>. You <strong>MUST</strong> only ever have <code>1</code> leader - the SDK will throw errors if you ever have more then one.</p> <p>The <code>leader</code> instance will be in an <code>iframe</code> hidden away in the start of the <code>&lt;body&gt;</code> and invisible. Once the user has logged in, the <a href="#authenticationcompleted"><code>authenticationCompleted</code></a> event is fired and the leader is completely authenticated. Any sensitive data passed between the leader and the follower is RSA-encrypted so nobody can decrypt it, <em>including</em> the dApp. The leader will keep everything in sync going forward (like nonces, blocks etc).</p> <p>You should never use the <code>leader</code> instance to show the standard UI as it doesn't route to certain views - it's mainly used for the communication, approval modals, KYC process and player protection. If you want to show any other Wallet UI please use a <code>follower</code> instance to do that.</p> <h2 id="what-is-a-follower"><a href="#what-is-a-follower" class="header-anchor">#</a> What is a Follower?</h2> <p>The follower is an instance you can spawn and destroy whenever you want. This is what you would use to show content on the UI for the Wallet. You can only ever have <code>1 leader</code> and <code>1 follower</code>, due to synchronisation being essential. This is a fixed limit.</p> <p>You must only ever spawn a follower when the <a href="#authenticationcompleted"><code>authenticationCompleted</code></a> event has fired and you know the leader instance is authenticated. You can also check this by using the <a href="#isauthenticated"><code>isAuthenticated</code></a> SDK method. This again is all shown in the Wallet integration test app.</p> <h2 id="secure-communication-between-the-leader-and-follower"><a href="#secure-communication-between-the-leader-and-follower" class="header-anchor">#</a> Secure Communication Between the Leader and Follower</h2> <p>The leader and the follower communicate using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API" target="_blank" rel="noopener noreferrer"><code>Broadcast Channel Api</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, or via cookies. Safari and Edge do not support the native <code>Broadcast Channel Api</code> so they communicate by saving and reading cookies.</p> <img src="/fun-wallet-docs/leader-follower-authentication-flow.png"> <p>As you can see in the above flow, all data passed between the instances is encrypted, meaning if someone did get to that data it's useless without the RSA private key. This private key is never exposed and is held in memory within the instances.</p> <h2 id="how-is-the-leader-and-follower-communication-secure"><a href="#how-is-the-leader-and-follower-communication-secure" class="header-anchor">#</a> How is the Leader and Follower Communication Secure?</h2> <p>💡 Every message between leader &gt; follower and follower &gt; leader is encrypted.</p> <p>💡 Even if the dApp could snoop (which it can't), the messages will be a blob of data without the RSA private key which is held in the instances memory, which means its a useless blob of data.
<br>
       💡 A dApp can't get to that as it's protected by cross-site scripting and standard Internet security.
<br></p> <p>💡 Broadcast API is something supported in most browsers, but not in Safari or Edge.
<br>
       💡 This can only broadcast to its own domain. For example, <code>wallet.funfair.io</code> can only speak to <code>wallet.funfair.io</code>, so it’s never exposed to anyone else.</p> <p>💡 Due to differences within Safari and Edge, we had to write our own broadcast logic for those browsers, which uses cookies to read and write values to each instance, again protected by the domain.</p> <p>💡 As client-side code is holding the private key in memory, there's no physical trace of it anywhere after you refresh. The encrypted session data may remain, but is useless without all the other encrypted data as it's double encrypted. This is also removed when you close the tab.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/funfair-tech/fun-wallet-docs/edit/master/packages/docs/dist/guide/how-does-it-work/leader-and-follower-communication.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/3/2020, 5:06:03 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fun-wallet-docs/guide/how-does-it-work/how-popup-authenticates-leader.html" class="prev">
        How the Authenticated Popup Authenticates the Leader
      </a></span> <span class="next"><a href="/fun-wallet-docs/guide/how-does-it-work/how-broadcast-works.html">
        How Broadcast Works
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/fun-wallet-docs/assets/js/app.6513ce21.js" defer></script><script src="/fun-wallet-docs/assets/js/2.a0d94ea1.js" defer></script><script src="/fun-wallet-docs/assets/js/17.09c5e52a.js" defer></script><script src="/fun-wallet-docs/assets/js/5.c35ce4c3.js" defer></script>
  </body>
</html>
